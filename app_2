import streamlit as st
import folium
from streamlit_folium import st_folium
import requests # API ìš”ì²­ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="Smart Taxi Finder", page_icon="ğŸš–")

# --- 1. ì„¤ì • ë° API í‚¤ ê°€ì ¸ì˜¤ê¸° ---
# ì£¼ì˜: ì‹¤ì œ ë°°í¬ì‹œì—ëŠ” API í‚¤ë¥¼ ì½”ë“œì— ì§ì ‘ ì ì§€ ë§ê³  st.secretsë¥¼ ì¨ì•¼ í•©ë‹ˆë‹¤. (ì•„ë˜ ì„¤ëª… ì°¸ì¡°)
KAKAO_API_KEY = st.secrets["kakao_api_key"] 

st.title("ğŸš– ìŠ¤ë§ˆíŠ¸ ì „ì‹œì¥ íƒì‹œ & ê¸¸ì°¾ê¸°")

# --- 2. ì „ì‹œì¥ ë°ì´í„° (ì¶œë°œì§€) ---
venues = {
    "COEX (ì„œìš¸ ì‚¼ì„±ë™)": {"coords": [37.5125, 127.0588], "desc": "ë™ë¬¸ ì• íƒì‹œ ìŠ¹ê°•ì¥"},
    "KINTEX (ì¼ì‚°)": {"coords": [37.6695, 126.7475], "desc": "ì œ1ì „ì‹œì¥ 3ë²ˆ ê²Œì´íŠ¸"},
    "BEXCO (ë¶€ì‚°)": {"coords": [35.1695, 129.1365], "desc": "ì œ1ì „ì‹œì¥ ì •ë¬¸ ì•"}
}

# ì‚¬ì´ë“œë°”: ì¶œë°œì§€ ì„ íƒ
st.sidebar.header("ğŸ“ ì¶œë°œì§€ (ì „ì‹œì¥)")
selected_venue = st.sidebar.selectbox("í˜„ì¬ ê³„ì‹  ê³³ì„ ì„ íƒí•˜ì„¸ìš”", list(venues.keys()))
start_coords = venues[selected_venue]["coords"]
start_desc = venues[selected_venue]["desc"]

# --- 3. ì¹´ì¹´ì˜¤ API í•¨ìˆ˜ (ì¥ì†Œ ê²€ìƒ‰) ---
def get_location_coords(query):
    url = "https://dapi.kakao.com/v2/local/search/keyword.json"
    headers = {"Authorization": f"KakaoAK {KAKAO_API_KEY}"}
    params = {"query": query}
    
    try:
        response = requests.get(url, headers=headers, params=params)
        data = response.json()
        if data['documents']:
            # ê°€ì¥ ì •í™•ë„ê°€ ë†’ì€ ì²« ë²ˆì§¸ ê²°ê³¼ì˜ ì¢Œí‘œ ë°˜í™˜ (y=ìœ„ë„, x=ê²½ë„)
            y = float(data['documents'][0]['y'])
            x = float(data['documents'][0]['x'])
            place_name = data['documents'][0]['place_name']
            return [y, x], place_name
        else:
            return None, None
    except Exception as e:
        return None, None

# --- 4. ë©”ì¸ í™”ë©´ ë¡œì§ ---
st.info(f"ğŸš© **í˜„ì¬ ì¶œë°œì§€:** {start_desc}")

# ëª©ì ì§€ ì…ë ¥ ë°›ê¸°
destination = st.text_input("ëª©ì ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì„œìš¸ì—­, í•˜ì–íŠ¸í˜¸í…”)", "")

destination_coords = None
destination_name = "ëª©ì ì§€"

if destination:
    # API í˜¸ì¶œ
    destination_coords, destination_name = get_location_coords(destination)
    
    if destination_coords:
        st.success(f"âœ… **{destination_name}**ì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!")
    else:
        st.error("ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# --- 5. ì§€ë„ ê·¸ë¦¬ê¸° (Folium) ---
# ì§€ë„ì˜ ì¤‘ì‹¬ì€ ì¶œë°œì§€ì™€ ë„ì°©ì§€ì˜ ì¤‘ê°„ì¯¤ìœ¼ë¡œ ì„¤ì •
if destination_coords:
    center_lat = (start_coords[0] + destination_coords[0]) / 2
    center_lng = (start_coords[1] + destination_coords[1]) / 2
    zoom = 11 # ì¤Œì„ ì•½ê°„ ë©€ë¦¬
else:
    center_lat, center_lng = start_coords
    zoom = 16

m = folium.Map(location=[center_lat, center_lng], zoom_start=zoom)

# ì¶œë°œì§€ ë§ˆì»¤ (íŒŒë‘ - íƒì‹œ)
folium.Marker(
    start_coords,
    popup=f"ì¶œë°œ: {selected_venue}",
    icon=folium.Icon(color="blue", icon="taxi", prefix='fa')
).add_to(m)

# ë„ì°©ì§€ ë§ˆì»¤ (ë¹¨ê°• - ê¹ƒë°œ)
if destination_coords:
    folium.Marker(
        destination_coords,
        popup=f"ë„ì°©: {destination_name}",
        icon=folium.Icon(color="red", icon="flag")
    ).add_to(m)
    
    # ì„  ê¸‹ê¸° (ì§ì„  ê²½ë¡œ í‘œì‹œ)
    folium.PolyLine(
        locations=[start_coords, destination_coords],
        color="red",
        weight=3,
        opacity=0.7,
        dash_array='5'
    ).add_to(m)

st_folium(m, width=700, height=400)

# --- 6. ì•± ì—°ë™ ë²„íŠ¼ (Dynamic Link) ---
if destination_coords:
    st.markdown("### ğŸƒâ€â™‚ï¸ ë°”ë¡œ ê¸¸ì°¾ê¸° ì‹¤í–‰")
    
    # ì¹´ì¹´ì˜¤ë§µ URL ìŠ¤í‚´ (ë„ì°©ì§€ ì¢Œí‘œ í¬í•¨)
    kakao_url = f"https://map.kakao.com/link/to/{destination_name},{destination_coords[0]},{destination_coords[1]}/from/{selected_venue},{start_coords[0]},{start_coords[1]}"
    
    st.link_button(f"ğŸš• ì¹´ì¹´ì˜¤ë§µìœ¼ë¡œ '{destination_name}' ê°€ëŠ” ê¸¸ ë³´ê¸°", kakao_url, use_container_width=True)

elif not destination:
    st.markdown("ëª©ì ì§€ë¥¼ ì…ë ¥í•˜ë©´ ê¸¸ì°¾ê¸° ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.")
